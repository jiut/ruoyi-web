# 前端日期格式修复指南

## 🚨 问题描述

**错误信息**：`Invalid value for EpochDay (valid values -365243219162 - 365241780471): 1019664000000`

**问题原因**：前端发送的是毫秒时间戳 `1019664000000`，但后端 `LocalDate` 字段期望 `yyyy-MM-dd` 格式的字符串。

## ✅ 解决方案

### 方案一：工具函数转换（推荐）

**1. 创建日期格式转换工具函数**

```typescript
// utils/dateUtils.ts
/**
 * 将时间戳或 Date 对象转换为 yyyy-MM-dd 格式字符串
 * @param value 时间戳(毫秒) | Date对象 | null | undefined
 * @returns yyyy-MM-dd 格式字符串或 null
 */
export const formatDateForApi = (value: number | Date | string | null | undefined): string | null => {
  if (!value) return null;

  let date: Date;

  if (typeof value === 'number') {
    date = new Date(value);
  } else if (typeof value === 'string') {
    date = new Date(value);
  } else {
    date = value;
  }

  // 验证日期有效性
  if (isNaN(date.getTime())) {
    console.warn('Invalid date value:', value);
    return null;
  }

  // 返回 yyyy-MM-dd 格式
  return date.toISOString().split('T')[0];
};
```

**2. 在提交时转换数据**

```typescript
// 设计师注册组件中
const handleSubmit = async () => {
  // 转换日期字段
  const submitData = {
    ...formData,
    birthDate: formatDateForApi(formData.birthDate),
    graduationDate: formatDateForApi(formData.graduationDate), // 如果有这个字段
  };

  // 移除空值字段
  Object.keys(submitData).forEach(key => {
    if (submitData[key] === null || submitData[key] === undefined || submitData[key] === '') {
      delete submitData[key];
    }
  });

  try {
    const response = await registerDesigner(submitData);
    // 处理成功
    console.log('注册成功:', response);
  } catch (error) {
    // 处理错误
    console.error('注册失败:', error);
  }
};
```

### 方案二：日期选择器配置（Element Plus）

如果使用 Element Plus：

```vue
<template>
  <el-date-picker
    v-model="formData.birthDate"
    type="date"
    placeholder="选择出生日期"
    format="YYYY-MM-DD"
    value-format="YYYY-MM-DD" <!-- 关键：直接输出字符串格式 --
  >
    />
  </el-date-picker>
</template>
```

### 方案三：日期选择器配置（Naive UI）

如果使用 Naive UI：

```vue
<script setup>
const formatDate = (ts: number) => {
  return new Date(ts).toISOString().split('T')[0]
}
</script>

<template>
  <n-date-picker
    v-model:value="formData.birthDate"
    type="date"
    :format="formatDate"
    value-format="yyyy-MM-dd" <!-- 关键：设置输出格式 --
  >
    placeholder="选择出生日期"
    />
  </n-date-picker>
</template>
```

### 方案四：原生 input[type="date"] 配置

如果使用原生 HTML 日期输入：

```vue
<template>
  <!-- 原生 input[type="date"] 默认就返回 yyyy-MM-dd 格式 -->
  <input
    v-model="formData.birthDate"
    type="date"
    class="custom-input w-full"
  >
</template>
```

## 🔧 完整示例代码

```vue
<script setup lang="ts">
import { ref } from 'vue'
import { formatDateForApi } from '@/utils/dateUtils'

// 表单数据
const formData = ref({
  designerName: '',
  birthDate: '',
  gender: '',
  phone: '',
  email: '',
  profession: '',
  workYears: 0,
  skillTags: '[]',
  description: ''
})

// 提交处理
const handleSubmit = async () => {
  // 数据预处理
  const submitData = {
    designerName: formData.value.designerName,
    birthDate: formatDateForApi(formData.value.birthDate),
    gender: formData.value.gender || undefined,
    phone: formData.value.phone || undefined,
    email: formData.value.email || undefined,
    profession: formData.value.profession || undefined,
    workYears: formData.value.workYears || 0,
    skillTags: formData.value.skillTags || '[]',
    description: formData.value.description || undefined,
  }

  // 移除空值字段
  Object.keys(submitData).forEach((key) => {
    if (submitData[key] === null || submitData[key] === undefined || submitData[key] === '')
      delete submitData[key]

  })

  try {
    const response = await fetch('/designer/register/designer', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(submitData)
    })

    if (response.ok)
      console.log('注册成功')
      // 跳转到成功页面
    else
      console.error('注册失败:', await response.text())

  }
  catch (error) {
    console.error('网络错误:', error)
  }
}
</script>

<template>
  <form @submit.prevent="handleSubmit">
    <!-- 姓名 - 必填 -->
    <div>
      <label>姓名 *</label>
      <input
        v-model="formData.designerName"
        type="text"
        required
        placeholder="请输入您的姓名"
      >
    </div>

    <!-- 出生日期 - 可选 -->
    <div>
      <label>出生日期</label>
      <input
        v-model="formData.birthDate"
        type="date"
        placeholder="选择出生日期"
      >
    </div>

    <!-- 其他字段... -->

    <button type="submit">
      注册
    </button>
  </form>
</template>
```

## 🧪 测试验证

**1. 验证转换函数**

```typescript
// 测试用例
console.log(formatDateForApi(1019664000000)); // 输出: "2002-04-25"
console.log(formatDateForApi(new Date('2002-04-25'))); // 输出: "2002-04-25"
console.log(formatDateForApi('2002-04-25')); // 输出: "2002-04-25"
console.log(formatDateForApi(null)); // 输出: null
console.log(formatDateForApi(undefined)); // 输出: null
```

**2. 验证提交数据格式**

```json
// 正确的提交数据格式
{
  "designerName": "路豪广",
  "avatar": "",
  "gender": "2",
  "birthDate": "2002-04-25", // ✅ 字符串格式，不是时间戳
  "phone": "17671813489",
  "email": "2315544955@qq.com",
  "profession": "ILLUSTRATOR",
  "skillTags": "[]",
  "workYears": 3,
  "description": "123456767890"
}
```

## 📝 修改清单

- [ ] 创建 `utils/dateUtils.ts` 工具文件
- [ ] 在设计师注册组件中导入工具函数
- [ ] 修改提交处理函数，使用 `formatDateForApi` 转换日期
- [ ] 测试时间戳转换功能
- [ ] 验证后端接口调用成功

## ⚠️ 注意事项

1. **空值处理**：确保空的日期字段不发送到后端
2. **时区问题**：`toISOString()` 使用 UTC 时间，对于日期（不含时间）影响很小
3. **兼容性**：此方案兼容所有主流日期选择器组件
4. **错误处理**：添加适当的错误处理和用户提示

---

**修复完成后，原错误 `Invalid value for EpochDay` 将不再出现。**
