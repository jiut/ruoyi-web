# 角色选择功能使用说明

## 📋 功能概述

本功能实现了全站检测普通角色用户并自动跳转到角色选择页面的机制。当用户注册后被自动赋予普通角色（角色ID为2）时，系统会检测到这种情况并引导用户选择专业角色。

## 🎯 支持的角色

| 角色名称 | 角色ID | 角色标识 | 说明 |
|---------|--------|----------|------|
| 设计师 | 1932319128081666050 | designer | 个人设计师用户 |
| 企业管理员 | 1932319128081666051 | enterprise | 企业管理用户 |
| 院校管理员 | 1932319128081666052 | school | 院校管理用户 |

## 🔧 实现原理

### 1. 角色检测逻辑

系统通过以下步骤检测用户角色状态：

1. **检查登录状态**：用户必须已登录
2. **检查角色类型**：用户是否为普通角色（角色ID为2）
3. **检查专业角色**：用户是否已选择专业角色
4. **判断是否需要选择**：同时满足以上条件时，需要选择角色

### 2. 路由拦截机制

在路由守卫中实现自动跳转：

```typescript
// 如果用户需要选择角色且不在角色选择页面，则跳转到角色选择页面
if (needsRoleSelection() && to.path !== '/role-selection') {
  next('/role-selection')
  return
}

// 如果用户在角色选择页面但不需要选择角色，则跳转到首页
if (to.path === '/role-selection' && !needsRoleSelection()) {
  next('/')
  return
}
```

## 🚀 使用方法

### 1. 用户注册后自动跳转

当新用户注册后：
1. 系统自动赋予普通角色（角色ID为2）
2. 用户访问任何页面时，系统检测到需要选择角色
3. 自动跳转到角色选择页面
4. 用户选择专业角色后，跳转到人才模块

### 2. 手动访问角色选择页面

用户可以通过以下方式访问角色选择页面：
- 直接访问 `/role-selection` 路径
- 点击角色选择提示组件中的"立即选择"按钮

### 3. 角色选择流程

1. **选择角色类型**：点击设计师、企业管理员或院校管理员卡片
2. **确认选择**：点击"确认选择"按钮
3. **系统更新**：调用API更新用户角色
4. **跳转页面**：成功后跳转到人才模块

## 📁 文件结构

```
src/
├── views/
│   ├── role-selection/
│   │   └── index.vue              # 角色选择页面
│   └── role-test/
│       └── index.vue              # 角色测试页面
├── components/
│   └── common/
│       └── RoleSelectionPrompt/
│           └── index.vue          # 角色选择提示组件
├── composables/
│   └── useRoleCheck.ts            # 角色检查Composable
├── utils/
│   └── authUtils.ts               # 角色检查工具函数
├── api/
│   └── user.ts                    # 用户API（包含更新角色接口）
├── store/
│   └── modules/
│       └── user/
│           ├── index.ts           # 用户Store
│           └── helper.ts          # 用户Store辅助函数
├── typings/
│   └── user.d.ts                  # 用户类型定义
└── router/
    ├── index.ts                   # 路由配置
    └── permission.ts              # 路由权限检查
```

## 🔌 API接口

### 更新用户角色

**接口**: `POST /system/user/updateRole`

**参数**:
```typescript
{
  roleId: string // 角色ID
}
```

**响应**:
```typescript
{
  code: number,
  msg: string,
  data: any
}
```

### 获取用户信息

**接口**: `GET /system/user/getInfo`

**响应**:
```typescript
{
  code: number,
  msg: string,
  data: {
    user: {
      userId: bigint,
      nickName: string,
      avatar: string,
      userBalance: number,
      roles: Array<{
        roleId: string,
        roleName: string,
        roleKey: string
      }>
    }
  }
}
```

## 🛠️ 开发工具

### 1. 角色检查Composable

```typescript
import { useRoleCheck } from '@/composables/useRoleCheck'

const {
  isLoading,
  currentRole,
  needsSelection,
  isNormalUser,
  hasProfessional,
  shouldSelectRole,
  isDesigner,
  isEnterprise,
  isSchool,
  checkRoleStatus,
  goToRoleSelection,
  getRoleDisplayName
} = useRoleCheck()
```

### 2. 角色检查工具函数

```typescript
import {
  isNormalRole,
  hasProfessionalRole,
  needsRoleSelection,
  getCurrentRole
} from '@/utils/authUtils'

// 检查是否为普通角色
const isNormal = isNormalRole()

// 检查是否已选择专业角色
const hasProfessional = hasProfessionalRole()

// 检查是否需要选择角色
const needsSelection = needsRoleSelection()

// 获取当前角色
const currentRole = getCurrentRole()
```

### 3. 测试页面

访问 `/role-test` 页面可以查看：
- 用户信息
- 角色状态
- 角色列表
- 各种操作按钮

## 🎨 界面组件

### 1. 角色选择页面

- **路径**: `/role-selection`
- **功能**: 展示三个角色卡片，用户可以选择其中一个
- **设计**: 响应式卡片布局，支持暗色主题

### 2. 角色选择提示组件

- **位置**: 页面右上角
- **触发条件**: 用户需要选择角色时
- **功能**: 提供快速跳转到角色选择页面的入口

### 3. 用户头像组件增强

- **显示内容**: 用户名、余额、角色标签
- **角色标签**: 显示当前角色的中文名称

## 🔒 权限控制

### 1. 白名单页面

以下页面不受角色选择限制：
- `/login` - 登录页面
- `/regist` - 注册页面
- `/resetpassword` - 重置密码页面
- `/role-selection` - 角色选择页面

### 2. 角色权限

- **普通用户**：只能访问角色选择页面
- **专业角色用户**：可以访问所有功能模块
- **未登录用户**：不受角色选择限制

## 🐛 故障排除

### 1. 常见问题

**Q: 用户无法跳转到角色选择页面**
A: 检查用户是否已登录，以及用户信息中是否包含角色数据

**Q: 角色选择后没有生效**
A: 检查API接口是否正常返回，以及用户Store是否正确更新

**Q: 角色选择页面显示异常**
A: 检查路由配置是否正确，以及组件是否正确导入

### 2. 调试方法

1. **查看控制台日志**：检查API请求和响应
2. **访问测试页面**：`/role-test` 页面显示详细的状态信息
3. **检查用户信息**：确认用户Store中的角色数据是否正确
4. **检查路由守卫**：确认路由拦截逻辑是否正常工作

## 📝 注意事项

1. **角色ID硬编码**：当前角色ID是硬编码的，如需修改请更新相关常量
2. **API接口依赖**：功能依赖后端提供正确的用户信息和角色更新接口
3. **本地存储**：角色选择提示的关闭状态保存在localStorage中
4. **响应式设计**：所有界面组件都支持响应式设计
5. **国际化支持**：界面文本支持国际化，但当前使用中文

## 🔄 后续优化

1. **角色管理界面**：添加角色管理功能，允许用户切换角色
2. **多角色支持**：支持用户同时拥有多个角色
3. **角色权限细化**：根据角色提供不同的功能权限
4. **角色申请流程**：添加角色申请和审批流程
5. **角色统计**：添加角色使用统计和分析功能
