<template>
  <div class="school-employment">
    <!-- 加载状态 -->
    <div v-if="loading" class="flex justify-center items-center py-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
      <span class="ml-2 text-gray-400">加载就业信息...</span>
    </div>

    <!-- 就业概况 -->
    <div v-else class="mb-6">
      <h4 class="text-lg font-bold mb-4">就业概况</h4>
      <div class="glass-card rounded-lg p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <div class="text-center p-3 bg-gray-800/30 rounded-lg">
            <p class="text-xs text-gray-400 mb-1">就业率</p>
            <p class="text-2xl font-bold text-green-400 mb-0">{{ employmentStats?.employmentRate || '--' }}</p>
          </div>
          <div class="text-center p-3 bg-gray-800/30 rounded-lg">
            <p class="text-xs text-gray-400 mb-1">平均起薪</p>
            <p class="text-2xl font-bold text-yellow-400 mb-0">{{ employmentStats?.averageSalary || '--' }}</p>
          </div>
          <div class="text-center p-3 bg-gray-800/30 rounded-lg">
            <p class="text-xs text-gray-400 mb-1">深造率</p>
            <p class="text-2xl font-bold text-blue-400 mb-0">{{ employmentStats?.furtherStudyRate || '--' }}</p>
          </div>
          <div class="text-center p-3 bg-gray-800/30 rounded-lg">
            <p class="text-xs text-gray-400 mb-1">海外就业率</p>
            <p class="text-2xl font-bold text-purple-400 mb-0">{{ employmentStats?.overseasEmploymentRate || '--' }}</p>
          </div>
        </div>
        <p class="text-sm text-gray-300 mb-0">
          {{ employmentStats?.description || '暂无就业描述' }}
        </p>
      </div>

      <!-- 数据可视化 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="w-full">
          <h5 class="text-base font-bold mb-3">就业行业分布</h5>
          <div ref="industryChartRef" class="w-full h-60" style="width: 100%; height: 240px;"></div>
        </div>
        <div class="w-full">
          <h5 class="text-base font-bold mb-3">薪资水平分布</h5>
          <div ref="salaryChartRef" class="w-full h-60" style="width: 100%; height: 240px;"></div>
        </div>
      </div>
    </div>

    <!-- 代表性雇主 -->
    <div>
      <h4 class="text-lg font-bold mb-4">代表性雇主</h4>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div
          v-for="employer in employers"
          :key="employer.id"
          class="glass-card rounded-lg p-4 text-center"
        >
          <div
            class="w-12 h-12 mx-auto flex items-center justify-center rounded-lg text-white mb-2"
            :class="employer.colorClass"
          >
            <span class="text-lg font-bold">{{ employer.initial }}</span>
          </div>
          <h5 class="text-sm font-bold">{{ employer.name }}</h5>
          <p class="text-xs text-gray-400 mb-0">{{ employer.industry }}</p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, nextTick, onUnmounted } from 'vue'
import * as echarts from 'echarts'
import { schoolApi } from '@/api/talent/school'

interface Props {
  schoolId: number
}

const props = defineProps<Props>()

const loading = ref(true)
const employmentStats = ref<any>(null)
const employers = ref<any[]>([])
const chartData = ref<any>(null)

const industryChartRef = ref<HTMLElement>()
const salaryChartRef = ref<HTMLElement>()
let industryChart: echarts.ECharts | null = null
let salaryChart: echarts.ECharts | null = null
let resizeObserver: ResizeObserver | null = null

// 环境配置：根据VITE_USE_MOCK_DATA切换数据源
const USE_MOCK_DATA = import.meta.env.VITE_USE_MOCK_DATA === 'true' ||
  (import.meta.env.VITE_USE_MOCK_DATA === undefined && import.meta.env.DEV)

console.log('🔍 就业模块环境变量调试信息:')
console.log('  VITE_USE_MOCK_DATA:', import.meta.env.VITE_USE_MOCK_DATA)
console.log('  DEV:', import.meta.env.DEV)
console.log('  USE_MOCK_DATA:', USE_MOCK_DATA)

// 获取就业数据
const fetchEmploymentData = async () => {
  loading.value = true
  try {
    const response = await schoolApi.getSchoolEmployment(props.schoolId)

    if (USE_MOCK_DATA) {
      // 使用模拟数据时的数据结构
      const mockResponse = response as { employmentStats: any; employers: any[]; chartData: any }
      employmentStats.value = mockResponse.employmentStats
      employers.value = mockResponse.employers
      chartData.value = mockResponse.chartData
    } else {
      // 使用后端API时的数据结构
      const apiResponse = response as { data?: { employmentStats?: any; employers?: any[]; chartData?: any } }
      employmentStats.value = apiResponse.data?.employmentStats || null
      employers.value = apiResponse.data?.employers || []
      chartData.value = apiResponse.data?.chartData || null
    }
  } catch (error) {
    console.error('获取就业数据失败:', error)
    // 发生错误时使用默认数据
    employmentStats.value = null
    employers.value = []
    chartData.value = null
  } finally {
    loading.value = false
  }
}

// 初始化图表
const initCharts = async () => {
  await nextTick()
  // 等待DOM完全渲染
  await new Promise(resolve => setTimeout(resolve, 50))

  if (industryChartRef.value) {
    // 强制设置容器尺寸
    const container = industryChartRef.value
    const parentWidth = container.parentElement?.clientWidth || 400
    container.style.width = `${parentWidth}px`
    container.style.height = '240px'

    industryChart = echarts.init(container, 'dark', {
      width: parentWidth,
      height: 240
    })
    const industryOption = {
      backgroundColor: 'transparent',
      tooltip: {
        trigger: 'item',
        backgroundColor: 'rgba(255, 255, 255, 0.8)',
        borderColor: 'rgba(255, 255, 255, 0.8)',
        textStyle: { color: '#1f2937' }
      },
      legend: {
        orient: 'vertical',
        right: 10,
        top: 'center',
        textStyle: { color: '#e2e8f0' }
      },
      series: [{
        name: '就业行业',
        type: 'pie',
        radius: ['45%', '70%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 10,
          borderColor: 'rgba(15, 23, 42, 0.6)',
          borderWidth: 2
        },
        label: { show: false, position: 'center' },
        emphasis: {
          label: {
            show: true,
            fontSize: '18',
            fontWeight: 'bold',
            color: '#e2e8f0'
          }
        },
        labelLine: { show: false },
        data: chartData.value?.industryData || [
          { value: 42, name: '互联网科技', itemStyle: { color: '#0a84ff' } },
          { value: 23, name: '设计咨询', itemStyle: { color: '#30d158' } },
          { value: 15, name: '广告传媒', itemStyle: { color: '#ff9f0a' } },
          { value: 12, name: '高校研究', itemStyle: { color: '#ff453a' } },
          { value: 8, name: '其他行业', itemStyle: { color: '#bf5af2' } }
        ]
      }]
    }
    industryChart.setOption(industryOption)
    // 强制调整大小以确保图表撑满容器
    setTimeout(() => {
      industryChart?.resize()
    }, 200)
  }

  if (salaryChartRef.value) {
    // 强制设置容器尺寸
    const container = salaryChartRef.value
    const parentWidth = container.parentElement?.clientWidth || 400
    container.style.width = `${parentWidth}px`
    container.style.height = '240px'

    salaryChart = echarts.init(container, 'dark', {
      width: parentWidth,
      height: 240
    })
    const salaryOption = {
      backgroundColor: 'transparent',
      tooltip: {
        trigger: 'axis',
        backgroundColor: 'rgba(255, 255, 255, 0.8)',
        borderColor: 'rgba(255, 255, 255, 0.8)',
        textStyle: { color: '#1f2937' }
      },
      xAxis: {
        type: 'category',
        data: chartData.value?.salaryLabels || ['8K-', '8-12K', '12-15K', '15-20K', '20-25K', '25K+'],
        axisLine: { lineStyle: { color: '#475569' } },
        axisLabel: { color: '#e2e8f0' }
      },
      yAxis: {
        type: 'value',
        axisLine: { lineStyle: { color: '#475569' } },
        axisLabel: { color: '#e2e8f0' },
        splitLine: { lineStyle: { color: '#334155' } }
      },
      series: [{
        data: chartData.value?.salaryData || [5, 12, 25, 30, 18, 10],
        type: 'bar',
        barWidth: '60%',
        itemStyle: {
          color: {
            type: 'linear',
            x: 0, y: 0, x2: 0, y2: 1,
            colorStops: [
              { offset: 0, color: '#0a84ff' },
              { offset: 1, color: 'rgba(10, 132, 255, 0.5)' }
            ]
          },
          borderRadius: [4, 4, 0, 0]
        }
      }]
    }
    salaryChart.setOption(salaryOption)
    // 强制调整大小以确保图表撑满容器
    setTimeout(() => {
      salaryChart?.resize()
    }, 200)
  }
}

// 处理窗口大小变化
const handleResize = () => {
  if (industryChart && industryChartRef.value) {
    const container = industryChartRef.value
    const parentWidth = container.parentElement?.clientWidth || 400
    container.style.width = `${parentWidth}px`
    industryChart.resize({
      width: parentWidth,
      height: 240
    })
  }

  if (salaryChart && salaryChartRef.value) {
    const container = salaryChartRef.value
    const parentWidth = container.parentElement?.clientWidth || 400
    container.style.width = `${parentWidth}px`
    salaryChart.resize({
      width: parentWidth,
      height: 240
    })
  }
}

// 初始化ResizeObserver
const initResizeObserver = () => {
  if (typeof ResizeObserver !== 'undefined') {
    resizeObserver = new ResizeObserver(() => {
      handleResize()
    })

    if (industryChartRef.value?.parentElement) {
      resizeObserver.observe(industryChartRef.value.parentElement)
    }
    if (salaryChartRef.value?.parentElement) {
      resizeObserver.observe(salaryChartRef.value.parentElement)
    }
  }
}

onMounted(async () => {
  // 先加载数据
  await fetchEmploymentData()

  // 数据加载完成后初始化图表
  await initCharts()
  initResizeObserver()
  window.addEventListener('resize', handleResize)

  // 额外的检查，确保图表正确初始化
  setTimeout(() => {
    handleResize()
  }, 500)
})

onUnmounted(() => {
  industryChart?.dispose()
  salaryChart?.dispose()
  resizeObserver?.disconnect()
  window.removeEventListener('resize', handleResize)
})
</script>

<style scoped>
.glass-card {
  background: rgba(28, 28, 30, 0.6);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(99, 99, 102, 0.2);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

/* 确保图表容器有明确的尺寸 */
.school-employment [ref="industryChartRef"],
.school-employment [ref="salaryChartRef"] {
  min-width: 200px;
  min-height: 240px;
}
</style>
